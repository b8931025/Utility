<html>
    <head>
        <title>Util</title>
    </head>
    <script lang="JavaScript">
        function onBtn1Click() {
            let inputValue = document.querySelector('#txtInput').value;
            let jsonObj = '';
            let txm ;
            let result = '';
            if (inputValue === '') return;
            let header,label,text;

            try{
                jsonObj = JSON.parse(inputValue);
                header = getProps(jsonObj,'header');
                label = getProps(jsonObj,'label');
                text = getProps(jsonObj,'text');
                /*
                tim > header
                    > basic > label
                    > text

                tom[0] > header
                    > basic > label
                    > text
                */
                if (jsonObj['tim'] === undefined && jsonObj['tom'] === undefined)  throw new Error('tim'); 
                if (header.length === 0)  throw new Error('header'); 
                if (text.length === 0)  throw new Error('text'); 
                if (label.length === 0)  throw new Error('label'); 

                header = header[0].value;
                text = text[0].value;
                label = label[0].value;
            }catch(e){
                alert('Json data格式錯誤,' + e.message);
                return;
            }

            result += '<<header>>\n';
            for (let x in header) result += header[x];
            colorLongTxt(header,"header","mainFrame1");

            result += '\n\n<<label>>\n'; 
            for (let x in label) result += label[x];
            colorLongTxt(label,"label","mainFrame2");

            result += '\n\n<<text>>\n'; 
            for (let x in text) result += text[x];
            colorLongTxt(text,"text","mainFrame3");

            document.querySelector('#txtOutput').value = result;
        }


        /**
         * 遞回找出屬性值
         * parameter:
         *      obj: Object
         *      propName: 屬性名稱
         * return :
         *      undefined:找不到
         *      result[]:
         *          result.value:屬性值
         *          result.position[]:屬性位置
         */
         function getProps(obj, propName){
            let pList = [];
            let position = [];

            let traversal = (_obj , _propName, _parent)=>{
                //取出所有屬性
                let prps = Object.keys(_obj);
                //取出datatype為物件的的屬性
                let opjs = prps.filter(x=> typeof(_obj[x]) === "object");
                let mapOK = prps.filter(x=>x==_propName);
                //紀錄路徑
                if (_parent === null || _parent === "" || _parent === undefined) {
                    position.push("<<root>>");
                }else{
                    position.push(_parent);
                }
                //找到的值
                if (mapOK.length > 0) {
                    pList.push({
                        "value":_obj[_propName], 
                        "position":Object.assign([], position)
                    });
                }
                //沒有下一層就離開
                if (opjs.length === 0) {
                    position.pop();
                    return;
                }

                for(let i = 0;i < opjs.length; i++){
                    let nodeName = opjs[i];
                    traversal(_obj[nodeName], propName, nodeName);
                }
            }

            traversal(obj, propName);
            return pList;
        }

        function colorLongTxt(obj,objName,frame){
            let cols = Object.keys(obj);
            document.querySelector("#" + frame).innerHTML = objName + ":<br/>";

            for(let i = 0 ; i < cols.length ; i++){
                let d = document.createElement('div');
                let modifyValue = obj[cols[i]].replace(/ /g,"&nbsp;")
                d.innerHTML = modifyValue;
                d.title = cols[i];
                d.className = "divUnit div" + (i % 2);
                document.querySelector("#" + frame).appendChild(d);       
            }
        }
    </script>
    <style type="text/css">
        #txtInput , #txtOutput {
            white-space: pre;
            overflow-wrap: normal;
            width: 100%;
            height: 150px;
            resize: none;
        }

        .divUnit {
            margin: 0px;
            display: inline-block;
        }

        .div0{
            color:brown;
            background-color:darkgrey;
        }

        .div1{
            color:black;
            background-color:darkgoldenrod;
        }

        .divFrame{
            display:flex;
            flex-direction: row;
            justify-content: left;
        }
    </style>
    <body>
        <input id="btn1" type="button" value="轉換" onclick="onBtn1Click();"/>
        <h3>JSON Data</h3><textarea id="txtInput" ></textarea>
        <h3>電文</h3><textarea id="txtOutput"></textarea>

        <br/>
        <div class="divFrame" id="mainFrame1"></div>
        <br/>
        <div class="divFrame" id="mainFrame2"></div>
        <br/>
        <div class="divFrame" id="mainFrame3"></div>
        

    </body>
</html>