<html>
    <head>
        <title>Util</title>
    </head>
    <script lang="JavaScript">
        function onBtn1Click() {
            let inputValue = document.querySelector('#txtInput').value;
            let jsonObj = '';
            let txm ;
            let result = '';
            if (inputValue === '') return;
            let header,label,text;

            try{
                jsonObj = JSON.parse(inputValue);
                header = getProp(jsonObj,'header');
                label = getProp(jsonObj,'label');
                text = getProp(jsonObj,'text');
                /*
                tim > header
                    > basic > label
                    > text

                tom[0] > header
                    > basic > label
                    > text
                */
                if (jsonObj['tim'] === undefined && jsonObj['tom'] === undefined)  throw new Error('tim'); 
                if (header === undefined)  throw new Error('header'); 
                if (text === undefined)  throw new Error('text'); 
                if (label === undefined)  throw new Error('label'); 

                header = header.prop;
                text = text.prop;
                label = label.prop;
            }catch(e){
                alert('Json data格式錯誤,' + e.message)    
                return;
            }

            result += '<<header>>\n';
            for (let x in header) result += header[x];

            result += '\n\n<<label>>\n'; 
            for (let x in label) result += label[x];

            result += '\n\n<<text>>\n'; 
            for (let x in text) result += text[x];
            document.querySelector('#txtOutput').value = result;
        }

        /**
         * 遞回找出屬性值，undefined表示沒找到
         * return {"prop":value} or undefined
         */
         function getProp(obj, propName){
            //找到該屬性就回傳
            let qryProp = Object.keys(obj).filter(x=>x==propName);
            //屬性值有可能是undefined，所以用物件儲存，代表有找到
            if (qryProp != "") return {"prop":obj[qryProp]};

            //這層找不到，就挑出所有物件，往下一層找
            let qryObjProps = Object.keys(obj).filter(x=> typeof(obj[x]) === "object");
            
            let result = undefined;
            for(let i = 0;i < qryObjProps.length; i++){
                result = getProp(obj[qryObjProps[i]],propName);
                //找到該屬性就回傳
                if (result !== undefined) return result;                
            }
        }        
    </script>
    <style type="text/css">
        #txtInput , #txtOutput {
            width: 100%;
            height: 150px;
        }
    </style>
    <body>
        <input id="btn1" type="button" value="轉換" onclick="onBtn1Click();"/>
        <h3>JSON Data</h3><textarea id="txtInput" ></textarea>
        <h3>電文</h3><textarea id="txtOutput"></textarea>
    </body>
</html>